<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Follow Through, Valentine's Getaway 2026</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: #111;
    color: #d4ccc4;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* ── Header ── */
  .header {
    background: linear-gradient(135deg, #0a1210 0%, #0f2a1a 40%, #0a1a14 100%);
    border-bottom: 1px solid rgba(125,206,160,0.12);
    padding: 40px 40px 36px;
    text-align: center;
    position: relative;
  }
  .header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    color: #fff;
    font-weight: 700;
    position: relative;
  }
  .header h1 span { color: #7dcea0; }
  .header .sub {
    font-size: 0.85rem;
    color: #7ab893;
    margin-top: 4px;
    position: relative;
  }
  .header-tag {
    display: inline-block;
    background: rgba(125,206,160,0.1);
    border: 1px solid rgba(125,206,160,0.2);
    color: #7dcea0;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    padding: 4px 12px;
    border-radius: 20px;
    margin-top: 10px;
    position: relative;
  }
  .back-btn {
    position: absolute;
    top: 50%;
    left: 24px;
    transform: translateY(-50%);
    background: rgba(125,206,160,0.1);
    border: 1px solid rgba(125,206,160,0.2);
    color: #7dcea0;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    padding: 6px 16px;
    border-radius: 20px;
    text-decoration: none;
    transition: all 0.2s;
    z-index: 2;
    touch-action: manipulation;
  }
  .back-btn:hover {
    background: rgba(125,206,160,0.2);
    border-color: rgba(125,206,160,0.4);
  }

  /* ── Layout ── */
  .layout {
    max-width: 900px;
    margin: 0 auto;
    padding: 32px 20px 60px;
    display: grid;
    grid-template-columns: 1fr 240px;
    gap: 24px;
  }

  /* ── Timeline ── */
  .timeline { display: flex; flex-direction: column; gap: 16px; }

  .day {
    background: #161616;
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 10px;
    overflow: hidden;
  }
  .day-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .day-label {
    background: rgba(125,206,160,0.1);
    border: 1px solid rgba(125,206,160,0.15);
    color: #7dcea0;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 3px 10px;
    border-radius: 20px;
    white-space: nowrap;
  }
  .day-label.valentine {
    background: rgba(232,101,122,0.12);
    border-color: rgba(232,101,122,0.2);
    color: #e8657a;
  }
  .day-name {
    font-weight: 700;
    font-size: 0.9rem;
    color: #fff;
  }
  .drop-zone {
    min-height: 48px;
    padding: 8px 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    transition: background 0.15s;
  }
  .drop-zone.drag-over {
    background: rgba(125,206,160,0.04);
  }
  .drop-zone-empty {
    color: #2a2222;
    font-size: 0.75rem;
    text-align: center;
    padding: 12px;
    pointer-events: none;
  }

  /* ── Cards ── */
  .card {
    background: #1e1e1e;
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.82rem;
    color: #b8b0a8;
    cursor: grab;
    transition: all 0.15s;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .card:hover {
    border-color: rgba(125,206,160,0.15);
    background: #222;
  }
  .card:active { cursor: grabbing; }
  .card.dragging {
    opacity: 0.4;
    transform: scale(0.96);
  }
  .card .grip {
    color: #3a3232;
    font-size: 0.7rem;
    flex-shrink: 0;
  }
  .card .text { flex: 1; }
  .card.locked {
    border-left: 3px solid #7dcea0;
  }
  .card.locked .lock-tag {
    font-size: 0.6rem;
    color: #7dcea0;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    flex-shrink: 0;
  }

  /* ── Idea Bank ── */
  .bank {
    position: sticky;
    top: 20px;
    align-self: start;
  }
  .bank-title {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    color: #7dcea0;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .bank-zone {
    min-height: 60px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 8px 0;
    transition: background 0.15s;
    border-radius: 8px;
  }
  .bank-zone.drag-over {
    background: rgba(125,206,160,0.04);
  }
  .bank-hint {
    font-size: 0.72rem;
    color: #2a2222;
    text-align: center;
    padding: 8px;
  }

  /* ── Trash zone ── */
  .trash-zone {
    border: 1px dashed rgba(255,80,80,0.15);
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    font-size: 0.72rem;
    color: #4a3232;
    margin-top: 16px;
    transition: all 0.15s;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .trash-zone.drag-over {
    background: rgba(255,80,80,0.08);
    border-color: rgba(255,80,80,0.4);
    color: #e06060;
  }

  /* ── New activity button ── */
  .new-btn {
    width: 100%;
    background: rgba(125,206,160,0.08);
    border: 1px dashed rgba(125,206,160,0.2);
    border-radius: 8px;
    padding: 10px;
    color: #7dcea0;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: 12px;
  }
  .new-btn:hover {
    background: rgba(125,206,160,0.14);
    border-color: rgba(125,206,160,0.35);
  }

  /* ── Save button ── */
  .save-btn {
    width: 100%;
    background: rgba(125,206,160,0.12);
    border: 1px solid rgba(125,206,160,0.25);
    border-radius: 8px;
    padding: 11px;
    color: #7dcea0;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: 16px;
  }
  .save-btn:hover {
    background: rgba(125,206,160,0.22);
    border-color: rgba(125,206,160,0.45);
  }
  .save-btn.saved {
    border-color: rgba(125,206,160,0.5);
    color: #a8e6c3;
  }

  .footer {
    text-align: center;
    padding: 24px;
    color: #2a2222;
    font-size: 0.7rem;
  }

  @media (max-width: 700px) {
    .layout {
      grid-template-columns: 1fr;
    }
    .bank { position: static; }
    .header { padding: 52px 20px 36px; }
    .back-btn {
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
    }
    .header h1 { font-size: 1.5rem; }
  }
</style>
</head>
<body>

<div class="header">
  <a href="index.html" class="back-btn">← The Plan</a>
  <h1>Follow <span>Through</span></h1>
  <div class="sub">Drag activities onto your timeline</div>
  <div class="header-tag" style="visibility:hidden;">Feb 12–16</div>
</div>

<div class="layout">

<div class="timeline">

  <!-- THU FEB 12 -->
  <div class="day">
    <div class="day-header">
      <span class="day-label">Thu Feb 12</span>
      <span class="day-name">Arrival</span>
    </div>
    <div class="drop-zone" data-day="thu">
      <div class="card locked" draggable="true" data-id="fly-out">
        <span class="grip">⠿</span>
        <span class="text">Fly LAX → SLC. Frontier 4130, 6:06pm</span>
        <span class="lock-tag">booked</span>
      </div>
      <div class="card" draggable="true" data-id="dinner-sarah-thu">
        <span class="grip">⠿</span>
        <span class="text">Maybe dinner with Sarah</span>
      </div>
    </div>
  </div>

  <!-- FRI FEB 13 -->
  <div class="day">
    <div class="day-header">
      <span class="day-label">Fri Feb 13</span>
      <span class="day-name">Ski Day</span>
    </div>
    <div class="drop-zone" data-day="fri">
      <div class="card" draggable="true" data-id="kneaders">
        <span class="grip">⠿</span>
        <span class="text">Kneaders breakfast, 8/8:30am, West Jordan with Sarah</span>
      </div>
      <div class="card" draggable="true" data-id="ski-day">
        <span class="grip">⠿</span>
        <span class="text">Ski day, pick a resort</span>
      </div>
      <div class="card" draggable="true" data-id="fri-dinner">
        <span class="grip">⠿</span>
        <span class="text">Dinner out</span>
      </div>
      <div class="card" draggable="true" data-id="hot-tub">
        <span class="grip">⠿</span>
        <span class="text">Sneak into a hot tub</span>
      </div>
    </div>
  </div>

  <!-- SAT FEB 14 -->
  <div class="day">
    <div class="day-header">
      <span class="day-label valentine">Sat Feb 14</span>
      <span class="day-name">Valentine's Day</span>
    </div>
    <div class="drop-zone" data-day="sat">
      <div class="card" draggable="true" data-id="chill-home">
        <span class="grip">⠿</span>
        <span class="text">Chill time at home</span>
      </div>
      <div class="card" draggable="true" data-id="vday-dinner">
        <span class="grip">⠿</span>
        <span class="text">Romantic Valentine's dinner</span>
      </div>
    </div>
  </div>

  <!-- SUN FEB 15 -->
  <div class="day">
    <div class="day-header">
      <span class="day-label">Sun Feb 15</span>
      <span class="day-name">Open Day</span>
    </div>
    <div class="drop-zone" data-day="sun">
      <div class="drop-zone-empty">Drag activities here</div>
    </div>
  </div>

  <!-- MON FEB 16 -->
  <div class="day">
    <div class="day-header">
      <span class="day-label">Mon Feb 16</span>
      <span class="day-name">Fly Home</span>
    </div>
    <div class="drop-zone" data-day="mon">
      <div class="card locked" draggable="true" data-id="fly-home">
        <span class="grip">⠿</span>
        <span class="text">Fly SLC → LAX. Frontier F9 1267, 9:29am</span>
        <span class="lock-tag">booked</span>
      </div>
      <div class="card" draggable="true" data-id="mon-homework">
        <span class="grip">⠿</span>
        <span class="text">Homework</span>
      </div>
    </div>
  </div>

</div>

<!-- IDEA BANK -->
<div class="bank">
  <div class="bank-title">Idea Bank</div>
  <div class="bank-zone" data-day="bank">
    <div class="card" draggable="true" data-id="alta-snowbird">
      <span class="grip">⠿</span>
      <span class="text">Alta or Snowbird</span>
    </div>
    <div class="card" draggable="true" data-id="homework">
      <span class="grip">⠿</span>
      <span class="text">Homework session</span>
    </div>
    <div class="card" draggable="true" data-id="brunch">
      <span class="grip">⠿</span>
      <span class="text">Brunch</span>
    </div>
    <div class="card" draggable="true" data-id="temple-square">
      <span class="grip">⠿</span>
      <span class="text">Temple Square</span>
    </div>
    <div class="card" draggable="true" data-id="nat-history">
      <span class="grip">⠿</span>
      <span class="text">Natural History Museum</span>
    </div>
    <div class="card" draggable="true" data-id="park-city">
      <span class="grip">⠿</span>
      <span class="text">Park City Main Street</span>
    </div>
    <div class="card" draggable="true" data-id="pick-up-skis">
      <span class="grip">⠿</span>
      <span class="text">Pick up skis from Sarah</span>
    </div>
    <div class="card" draggable="true" data-id="movie-night">
      <span class="grip">⠿</span>
      <span class="text">Movie night in</span>
    </div>
    <div class="card" draggable="true" data-id="sunset-drive">
      <span class="grip">⠿</span>
      <span class="text">Scenic drive</span>
    </div>
  </div>
  <button class="new-btn" id="newActivity">+ New activity</button>
  <div class="trash-zone" id="trashZone">Drop here to remove</div>
  <button class="save-btn" id="saveBtn">Save Plan</button>
</div>

</div>

<div class="footer">Follow Through, Valentine's Getaway 2026</div>

<script>
  const API_BASE = 'https://visionary-raindrop-cd221f.netlify.app/.netlify/functions';
  const LOCAL_KEY = 'followthrough-plan';
  let draggedCard = null;
  let plan = null;

  // ══════════ DEFAULT PLAN (fallback) ══════════
  const defaultPlan = {
    lastUpdated: null,
    days: {
      thu: {
        label: 'Arrival',
        activities: [
          { id: 'fly-out', text: 'Fly LAX → SLC. Frontier 4130, 6:06pm', status: 'booked' },
          { id: 'dinner-sarah-thu', text: 'Maybe dinner with Sarah', status: 'idea' }
        ]
      },
      fri: {
        label: 'Ski Day',
        activities: [
          { id: 'kneaders', text: 'Kneaders breakfast, 8/8:30am, West Jordan with Sarah', status: 'idea' },
          { id: 'ski-day', text: 'Ski day, pick a resort', status: 'idea' },
          { id: 'fri-dinner', text: 'Dinner out', status: 'idea' },
          { id: 'hot-tub', text: 'Sneak into a hot tub', status: 'idea' }
        ]
      },
      sat: {
        label: "Valentine's Day",
        activities: [
          { id: 'chill-home', text: 'Chill time at home', status: 'idea' },
          { id: 'vday-dinner', text: 'Romantic Valentine\'s dinner', status: 'idea' }
        ]
      },
      sun: {
        label: 'Open Day',
        activities: []
      },
      mon: {
        label: 'Fly Home',
        activities: [
          { id: 'fly-home', text: 'Fly SLC → LAX. Frontier F9 1267, 9:29am', status: 'booked' },
          { id: 'mon-homework', text: 'Homework', status: 'idea' }
        ]
      }
    },
    ideaBank: [
      { id: 'alta-snowbird', text: 'Alta or Snowbird', status: 'idea' },
      { id: 'homework', text: 'Homework session', status: 'idea' },
      { id: 'brunch', text: 'Brunch', status: 'idea' },
      { id: 'temple-square', text: 'Temple Square', status: 'idea' },
      { id: 'nat-history', text: 'Natural History Museum', status: 'idea' },
      { id: 'park-city', text: 'Park City Main Street', status: 'idea' },
      { id: 'pick-up-skis', text: 'Pick up skis from Sarah', status: 'idea' },
      { id: 'movie-night', text: 'Movie night in', status: 'idea' },
      { id: 'sunset-drive', text: 'Scenic drive', status: 'idea' }
    ]
  };

  // ══════════ CARD CREATION ══════════
  function makeCard(activity) {
    const card = document.createElement('div');
    card.className = 'card' + (activity.status === 'booked' ? ' locked' : '');
    card.draggable = true;
    card.dataset.id = activity.id;
    let html = `<span class="grip">⠿</span><span class="text">${activity.text}</span>`;
    if (activity.status === 'booked') html += `<span class="lock-tag">booked</span>`;
    card.innerHTML = html;
    return card;
  }

  // ══════════ RENDER PLAN → DOM ══════════
  function renderPlan(p) {
    plan = p;
    // Clear all zones
    document.querySelectorAll('.drop-zone').forEach(zone => {
      zone.querySelectorAll('.card, .drop-zone-empty').forEach(el => el.remove());
    });
    document.querySelector('.bank-zone').querySelectorAll('.card, .bank-hint').forEach(el => el.remove());

    // Populate day zones
    Object.entries(plan.days).forEach(([dayId, day]) => {
      const zone = document.querySelector(`[data-day="${dayId}"]`);
      if (!zone) return;
      day.activities.forEach(act => zone.appendChild(makeCard(act)));
    });

    // Populate idea bank
    const bankZone = document.querySelector('.bank-zone');
    plan.ideaBank.forEach(act => bankZone.appendChild(makeCard(act)));

    applyBookedTags();
    updateEmptyStates();
    setupDesktopDrag();
  }

  // ══════════ DOM → PLAN OBJECT ══════════
  function buildPlanFromDOM() {
    const days = {};
    document.querySelectorAll('.drop-zone[data-day]').forEach(zone => {
      const dayId = zone.dataset.day;
      const label = plan.days[dayId] ? plan.days[dayId].label : dayId;
      const activities = [...zone.querySelectorAll('.card')].map(c => ({
        id: c.dataset.id,
        text: c.querySelector('.text').textContent,
        status: c.classList.contains('locked') ? 'booked' : 'idea'
      }));
      days[dayId] = { label, activities };
    });
    const ideaBank = [...document.querySelector('.bank-zone').querySelectorAll('.card')].map(c => ({
      id: c.dataset.id,
      text: c.querySelector('.text').textContent,
      status: c.classList.contains('locked') ? 'booked' : 'idea'
    }));
    plan.days = days;
    plan.ideaBank = ideaBank;
    return plan;
  }

  // ══════════ APPLY BOOKED TAGS ══════════
  function applyBookedTags() {
    document.querySelectorAll('.card').forEach(card => {
      const textEl = card.querySelector('.text');
      if (!textEl) return;
      const match = textEl.textContent.match(/\s*\(booked\)\s*$/i);
      if (match) {
        textEl.textContent = textEl.textContent.replace(/\s*\(booked\)\s*$/i, '').trim();
        if (!card.classList.contains('locked')) {
          card.classList.add('locked');
          const tag = document.createElement('span');
          tag.className = 'lock-tag';
          tag.textContent = 'booked';
          card.appendChild(tag);
        }
      }
    });
  }

  // ══════════ LOCAL CACHE ══════════
  function cacheLocally() {
    buildPlanFromDOM();
    localStorage.setItem(LOCAL_KEY, JSON.stringify(plan));
  }

  // ══════════ HELPERS ══════════
  function getAllZones() {
    return document.querySelectorAll('.drop-zone, .bank-zone');
  }

  function findInsertPosition(zone, y) {
    const cards = [...zone.querySelectorAll('.card:not(.dragging)')];
    const after = cards.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) return { offset, el: child };
      return closest;
    }, { offset: Number.NEGATIVE_INFINITY });
    return after.el || null;
  }

  function getZoneAt(x, y) {
    let found = null;
    getAllZones().forEach(zone => {
      const r = zone.getBoundingClientRect();
      if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom) found = zone;
    });
    const tr = trash.getBoundingClientRect();
    if (x >= tr.left && x <= tr.right && y >= tr.top && y <= tr.bottom) return 'trash';
    return found;
  }

  // ══════════ DESKTOP DRAG & DROP ══════════
  function setupDesktopDrag() {
    getAllZones().forEach(zone => {
      zone.addEventListener('dragover', e => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        zone.classList.add('drag-over');
        const before = findInsertPosition(zone, e.clientY);
        if (before) zone.insertBefore(draggedCard, before);
        else zone.appendChild(draggedCard);
      });
      zone.addEventListener('dragleave', e => {
        if (!zone.contains(e.relatedTarget)) zone.classList.remove('drag-over');
      });
      zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        updateEmptyStates();
        cacheLocally();
      });
    });
  }

  document.addEventListener('dragstart', e => {
    const card = e.target.closest('.card');
    if (!card) return;
    draggedCard = card;
    card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });

  document.addEventListener('dragend', e => {
    const card = e.target.closest('.card');
    if (card) card.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(z => z.classList.remove('drag-over'));
    draggedCard = null;
  });

  // ══════════ TOUCH DRAG & DROP ══════════
  let touchClone = null;
  let touchStartY = 0;
  let touchStartX = 0;
  let touchMoved = false;

  document.addEventListener('touchstart', e => {
    if (e.target.closest('a, button')) return;
    const card = e.target.closest('.card');
    if (!card) return;
    const t = e.touches[0];
    touchStartX = t.clientX;
    touchStartY = t.clientY;
    touchMoved = false;
    draggedCard = card;
  }, { passive: true });

  document.addEventListener('touchmove', e => {
    if (!draggedCard) return;
    const t = e.touches[0];
    if (!touchMoved) {
      const dx = t.clientX - touchStartX;
      const dy = t.clientY - touchStartY;
      if (Math.sqrt(dx*dx + dy*dy) < 8) return;
      touchMoved = true;
      draggedCard.classList.add('dragging');
      touchClone = draggedCard.cloneNode(true);
      touchClone.style.cssText = 'position:fixed;pointer-events:none;z-index:999;opacity:0.85;width:' + draggedCard.offsetWidth + 'px;';
      document.body.appendChild(touchClone);
    }
    e.preventDefault();
    if (touchClone) {
      touchClone.style.left = (t.clientX - touchClone.offsetWidth / 2) + 'px';
      touchClone.style.top = (t.clientY - 20) + 'px';
    }
    document.querySelectorAll('.drag-over').forEach(z => z.classList.remove('drag-over'));
    const target = getZoneAt(t.clientX, t.clientY);
    if (target === 'trash') {
      trash.classList.add('drag-over');
    } else if (target) {
      target.classList.add('drag-over');
      const before = findInsertPosition(target, t.clientY);
      if (before) target.insertBefore(draggedCard, before);
      else target.appendChild(draggedCard);
    }
  }, { passive: false });

  document.addEventListener('touchend', e => {
    if (!draggedCard) return;
    if (touchClone) { touchClone.remove(); touchClone = null; }
    if (touchMoved) {
      const lastTouch = e.changedTouches[0];
      const target = getZoneAt(lastTouch.clientX, lastTouch.clientY);
      if (target === 'trash') draggedCard.remove();
      draggedCard.classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(z => z.classList.remove('drag-over'));
      updateEmptyStates();
      cacheLocally();
    }
    draggedCard = null;
    touchMoved = false;
  });

  // ══════════ EMPTY STATES ══════════
  function updateEmptyStates() {
    document.querySelectorAll('.drop-zone').forEach(zone => {
      const existing = zone.querySelector('.drop-zone-empty');
      const hasCards = zone.querySelector('.card');
      if (!hasCards && !existing) {
        const msg = document.createElement('div');
        msg.className = 'drop-zone-empty';
        msg.textContent = 'Drag activities here';
        zone.appendChild(msg);
      } else if (hasCards && existing) {
        existing.remove();
      }
    });
    const bankZone = document.querySelector('.bank-zone');
    const bankEmpty = bankZone.querySelector('.bank-hint');
    const bankHasCards = bankZone.querySelector('.card');
    if (!bankHasCards && !bankEmpty) {
      const msg = document.createElement('div');
      msg.className = 'bank-hint';
      msg.textContent = 'All activities placed!';
      bankZone.appendChild(msg);
    } else if (bankHasCards && bankEmpty) {
      bankEmpty.remove();
    }
  }

  // ══════════ TRASH (desktop) ══════════
  const trash = document.getElementById('trashZone');
  trash.addEventListener('dragover', e => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    trash.classList.add('drag-over');
  });
  trash.addEventListener('dragleave', e => {
    if (!trash.contains(e.relatedTarget)) trash.classList.remove('drag-over');
  });
  trash.addEventListener('drop', e => {
    e.preventDefault();
    trash.classList.remove('drag-over');
    if (draggedCard) {
      draggedCard.remove();
      draggedCard = null;
      updateEmptyStates();
      cacheLocally();
    }
  });

  // ══════════ NEW ACTIVITY ══════════
  let newCount = 0;
  document.getElementById('newActivity').addEventListener('click', () => {
    const text = prompt('Activity name:');
    if (!text || !text.trim()) return;
    const id = 'custom-' + Date.now() + '-' + (++newCount);
    const card = makeCard({ id, text: text.trim(), status: 'idea' });
    document.querySelector('.bank-zone').appendChild(card);
    applyBookedTags();
    updateEmptyStates();
    cacheLocally();
  });

  // ══════════ SAVE BUTTON (API) ══════════
  document.getElementById('saveBtn').addEventListener('click', async () => {
    const btn = document.getElementById('saveBtn');
    btn.textContent = 'Saving...';
    btn.disabled = true;

    buildPlanFromDOM();
    plan.lastUpdated = new Date().toISOString();

    try {
      const res = await fetch(API_BASE + '/save-plan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(plan)
      });
      const data = await res.json();
      if (data.ok) {
        localStorage.setItem(LOCAL_KEY, JSON.stringify(plan));
        btn.textContent = 'Saved ✓';
        btn.classList.add('saved');
      } else {
        console.error('Save response:', data);
        btn.textContent = 'Failed: ' + (data.error || res.status);
        if (data.detail) console.error('Detail:', data.detail);
        var debugInfo = data.debug ? '\n\nDebug: ' + JSON.stringify(data.debug) : '';
        alert('Save failed:\n' + (data.error || '') + '\n' + (data.detail || '') + debugInfo);
      }
    } catch (err) {
      console.error('Save error:', err);
      btn.textContent = 'Error: ' + err.message;
      alert('Save error:\n' + err.message);
    }

    btn.disabled = false;
    setTimeout(() => {
      btn.textContent = 'Save Plan';
      btn.classList.remove('saved');
    }, 3000);
  });

  // ══════════ NAV BUTTON FALLBACK ══════════
  document.querySelector('.back-btn').addEventListener('touchend', function(e) {
    e.stopPropagation();
    window.location.href = this.getAttribute('href');
  });

  // ══════════ INIT: LOAD FROM API ══════════
  (async function init() {
    let loaded = false;
    try {
      const res = await fetch(API_BASE + '/load-plan');
      const data = await res.json();
      if (data.ok && data.plan && data.plan.days) {
        renderPlan(data.plan);
        loaded = true;
      }
    } catch (err) {
      console.warn('API load failed, trying local cache:', err);
    }

    if (!loaded) {
      // Try local cache
      try {
        const cached = JSON.parse(localStorage.getItem(LOCAL_KEY));
        if (cached && cached.days) {
          renderPlan(cached);
          loaded = true;
        }
      } catch(e) {}
    }

    if (!loaded) {
      // Fall back to default
      renderPlan(JSON.parse(JSON.stringify(defaultPlan)));
    }
  })();
</script>

</body>
</html>
